# Transactions API

RESTful service that stores financial transactions in memory and exposes queries over them.

## Architecture

The project follows **Hexagonal Architecture** (Ports & Adapters):

```
src/main/java/org/example/transactionsapi/
├── domain/
│   ├── model/
│   │   ├── Transaction.java                       # Immutable domain entity (record)
│   │   └── TransactionNotFoundException.java      # Domain exception
│   ├── port/
│   │   ├── in/                                    # Driving ports (use-case interfaces)
│   │   │   ├── CreateTransactionUseCase.java
│   │   │   ├── UpsertTransactionUseCase.java
│   │   │   ├── GetTransactionByIdUseCase.java
│   │   │   ├── GetTransactionsByTypeUseCase.java
│   │   │   └── GetTransactionSumUseCase.java
│   │   └── out/                                   # Driven port (repository interface)
│   │       └── TransactionRepository.java
│   └── service/
│       └── TransactionService.java                # Pure domain logic, no framework deps
├── adapter/
│   ├── in/web/
│   │   ├── TransactionController.java             # REST controller
│   │   ├── GlobalExceptionHandler.java            # HTTP error mapping
│   │   └── dto/                                   # Request/response DTOs
│   └── out/persistence/
│       └── InMemoryTransactionRepository.java     # In-memory implementation
├── BeanConfiguration.java                         # Spring wiring (domain ↔ adapter)
└── TransactionsApiApplication.java
```

**To replace the in-memory storage** with any database, simply implement `TransactionRepository` and register the new bean — zero changes to domain or web code.

## API

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/transactions` | Create a transaction (id auto-generated, returned in response) |
| `PUT`  | `/transactions/{id}` | Idempotent upsert (id in path) |
| `GET`  | `/transactions/{id}` | Retrieve a transaction by id |
| `GET`  | `/transactions/types/{type}` | List all transaction ids for a type |
| `GET`  | `/transactions/sum/{id}` | Transitive sum of a transaction and its descendants |

---

### `POST /transactions`
Creates a new transaction. The id is auto-generated by the server. Returns `201 Created`.

**Body**
```json
{ "amount": 5000, "type": "cars", "parent_id": 9 }
```
`parent_id` is optional.

**Response** `201`
```json
{ "id": 1 }
```

---

### `PUT /transactions/{transaction_id}`
Idempotent upsert — creates or fully replaces the transaction with the given id. Returns `200 OK`.

**Body**
```json
{ "amount": 5000, "type": "cars", "parent_id": 9 }
```
`parent_id` is optional.

**Response** `200`
```json
{ "status": "ok" }
```

---

### `GET /transactions/{transaction_id}`
Returns the full details of a single transaction. Returns `404` if not found.

**Response** `200`
```json
{ "id": 10, "amount": 5000.0, "type": "cars" }
```
`parent_id` is included only when present.

---

### `GET /transactions/types/{type}`
Returns a list of all transaction ids for the given type.

**Response** `200`
```json
[10, 12]
```

---

### `GET /transactions/sum/{transaction_id}`
Returns the sum of amounts for the transaction and all its transitive descendants. Returns `404` if not found.

**Response** `200`
```json
{ "sum": 20000.0 }
```

---

### Example
```
POST /transactions  { "amount": 5000,  "type": "cars" }              →  { "id": 1 }
POST /transactions  { "amount": 10000, "type": "shopping", "parent_id": 1 }  →  { "id": 2 }
POST /transactions  { "amount": 5000,  "type": "shopping", "parent_id": 2 }  →  { "id": 3 }

GET /transactions/1            →  { "id": 1, "amount": 5000.0, "type": "cars" }
GET /transactions/types/cars   →  [1]
GET /transactions/sum/1        →  { "sum": 20000.0 }
GET /transactions/sum/2        →  { "sum": 15000.0 }
```

## Running locally

```bash
./gradlew bootRun
```

## Tests

```bash
./gradlew test
```

## Docker

```bash
# Build
docker build -t transactions-api .

# Run
docker run -p 8080:8080 transactions-api
```
